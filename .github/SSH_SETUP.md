# Настройка SSH ключей для деплоя

## Шаг 1: Создание SSH ключа (если его еще нет)

Если у вас уже есть SSH ключ, пропустите этот шаг.

```bash
# Создайте новый SSH ключ (замените email на ваш)
ssh-keygen -t ed25519 -C "github-actions-deploy" -f ~/.ssh/github_actions_deploy

# Или используйте существующий ключ
# Если у вас уже есть ключ, используйте его путь
```

**Важно:** При создании ключа можно оставить пароль пустым (просто нажмите Enter), так как он будет использоваться в автоматическом деплое.

## Шаг 2: Добавление публичного ключа на сервер

### Вариант A: Если у вас уже есть доступ к серверу по SSH

```bash
# Скопируйте публичный ключ на сервер
ssh-copy-id -i ~/.ssh/github_actions_deploy.pub user@your-server-ip

# Или вручную:
cat ~/.ssh/github_actions_deploy.pub | ssh user@your-server-ip "mkdir -p ~/.ssh && cat >> ~/.ssh/authorized_keys"
```

### Вариант B: Если у вас нет доступа, попросите администратора сервера

Отправьте администратору содержимое публичного ключа:
```bash
cat ~/.ssh/github_actions_deploy.pub
```

Администратор должен добавить этот ключ в файл `~/.ssh/authorized_keys` на сервере:
```bash
# На сервере выполните:
mkdir -p ~/.ssh
chmod 700 ~/.ssh
echo "ВАШ_ПУБЛИЧНЫЙ_КЛЮЧ" >> ~/.ssh/authorized_keys
chmod 600 ~/.ssh/authorized_keys
```

## Шаг 3: Добавление приватного ключа в GitHub Secrets

1. Откройте ваш репозиторий на GitHub
2. Перейдите в `Settings` → `Secrets and variables` → `Actions`
3. Нажмите `New repository secret`
4. Создайте секрет с именем `SSH_PRIVATE_KEY`
5. Скопируйте **весь** приватный ключ (включая строки `-----BEGIN` и `-----END`):

```bash
# Показать приватный ключ
cat ~/.ssh/github_actions_deploy
```

**Важно:** Скопируйте весь ключ, включая:
```
-----BEGIN OPENSSH PRIVATE KEY-----
...
...
-----END OPENSSH PRIVATE KEY-----
```

## Шаг 4: Добавление других секретов

Также создайте следующие секреты:

- **SERVER_USER** - имя пользователя на сервере (например: `root`, `deploy`, `ubuntu`)
- **SERVER_HOST** - IP адрес или домен сервера (например: `192.168.1.100` или `example.com`)
- **SERVER_PATH** - путь к директории проекта на сервере (например: `/var/www/barakad`)

## Шаг 5: Проверка подключения

Проверьте, что SSH подключение работает:

```bash
# Проверка подключения
ssh -i ~/.ssh/github_actions_deploy user@your-server-ip

# Если подключение успешно, вы увидите приглашение сервера
```

## Шаг 6: Настройка прав доступа

Убедитесь, что ключ имеет правильные права:

```bash
chmod 600 ~/.ssh/github_actions_deploy
chmod 644 ~/.ssh/github_actions_deploy.pub
```

## Безопасность

- **Никогда** не коммитьте приватные ключи в репозиторий
- Используйте отдельный ключ для деплоя (не ваш личный)
- Ограничьте права ключа на сервере (если возможно, используйте отдельного пользователя для деплоя)
- Регулярно ротируйте ключи

## Troubleshooting

### Ошибка "Permission denied (publickey)"
- Проверьте, что публичный ключ добавлен в `~/.ssh/authorized_keys` на сервере
- Проверьте права доступа: `chmod 600 ~/.ssh/authorized_keys`
- Проверьте, что пользователь существует на сервере

### Ошибка "Host key verification failed"
- Добавьте сервер в known_hosts вручную или используйте `ssh-keyscan`

### Ошибка при деплое
- Проверьте логи GitHub Actions
- Убедитесь, что все секреты правильно настроены
- Проверьте, что Docker установлен на сервере

